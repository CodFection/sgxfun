# Use of EPID signatures in SGX

In SGX, EPID lets an enclave attest that it's running a given software
(through its `MRENCLAVE` identity) on a given CPU (model, microcode
version, etc.). The use of EPID within SGX is already documented in
Intel's [EPID Provisioning and
Attestation
Services](https://software.intel.com/en-us/blogs/2016/03/09/intel-sgx-epid-provisioning-and-attestation-services)
document, and EPID is described in detail in [Enhanced Privacy ID from
Bilinear Pairing](https://eprint.iacr.org/2009/095).  This note
summarizes those and provides additional details. You should read the
above document to best understand the following.

First, a quick terminology summary:

* The **issuer** (Intel) is the only party who knows the *issuing signing key*
  (ISK), called "Intel Signing Key" in [EPID Provisioning and
  Attestation
  Services](https://software.intel.com/en-us/blogs/2016/03/09/intel-sgx-epid-provisioning-and-attestation-services).
  The *group public key* (GPK) is published within a group public key
  certificate signed by the ISK, and verifiable using the ISK's
  associated public key (which is not the GPK).

* **Members** (CPUs) join the group through an interactive protocol with the
  issuer, in such a way that the issuer doesn't know the *member private
  key* SK. Given a enclave's `REPORT` (a measurement that includes the
  `MRENCLAVE` and `MRSIGNER` identities), a member creates a `QUOTE`
   that includes an EPID signature of the `REPORT`. The `QUOTE` acts as
   an attestation that the enclave does run on a trusted SGX platform.

* **Verifiers** are applications running the enclave (locally or
  remotely), and that will verify that a given `MRENCLAVE` runs on a
  given TCB.

Some important features of EPID in SGX are:

* **Anonymity**: When a group member issues a signature, no one can
  identify the member given the signature, even the issuer. The goal is
  to prevent the tracking of users through their CPUs.

* **(Un)linkability**: Members have the choice to make signatures either
  linkable or unlinkable. With linkable signatures, there'll be a way 


## How's EPID implemented in SGX?

A large part of the EPID implementation is found in the quoting enclave
(QE), which EPID-signs a report and creates a `QUOTE` that includes this
signature. The QE binary exposes the following EPID member functions:

* `epidMember_create`
* `epidMember_createCompressed`
* `epidMember_delete`
* `epidMember_registerBaseName`
* `epidMember_computePreSignature`
* `epidMember_join`
* `epidMember_isPrivKeyValid`
* `epidMember_signMessagePartial`
* `epidMember_checkSigRLHeader`
* `epidMember_nrProve`
* `epidMember_signMessage`

Specifically, the `get_quote` function in `sgx_get_quote` calls
`epidMember_signMessagePartial` to sign a report and
`epidMember_nrProve` to generate non-revoked proofs.

The Linux platform software uses the following group key certificate,
including the group key and a signature by Intel's ISK, as found in
<https://github.com/01org/linux-sgx/blob/9441de4c38700bbc573bb0d363c34387022b7b1c/sdk/simulation/uae_service_sim/quoting_sim.cpp>:

```
static const uint8_t EPID_GROUP_CERT[] = {
    0x00, 0x00, 0x00, 0x0B, 0xB3, 0x6F, 0xFF, 0x81, 0xE2, 0x1B, 0x17, 0xEB,
    0x3D, 0x75, 0x3D, 0x61, 0x7E, 0x27, 0xB0, 0xCB, 0xD0, 0x6D, 0x8F, 0x9D,
    0x64, 0xCE, 0xE3, 0xCE, 0x43, 0x4C, 0x62, 0xFD, 0xB5, 0x80, 0xE0, 0x99,
    0x3A, 0x07, 0x56, 0x80, 0xE0, 0x88, 0x59, 0xA4, 0xFD, 0xB5, 0xB7, 0x9D,
    0xE9, 0x4D, 0xAE, 0x9C, 0xEE, 0x3D, 0x66, 0x42, 0x82, 0x45, 0x7E, 0x7F,
    0xD8, 0x69, 0x3E, 0xA1, 0x74, 0xF4, 0x59, 0xEE, 0xD2, 0x74, 0x2E, 0x9F,
    0x63, 0xC2, 0x51, 0x8E, 0xD5, 0xDB, 0xCA, 0x1C, 0x54, 0x74, 0x10, 0x7B,
    0xDC, 0x99, 0xED, 0x42, 0xD5, 0x5B, 0xA7, 0x04, 0x29, 0x66, 0x61, 0x63,
    0xBC, 0xDD, 0x7F, 0xE1, 0x76, 0x5D, 0xC0, 0x6E, 0xE3, 0x14, 0xAC, 0x72,
    0x48, 0x12, 0x0A, 0xA6, 0xE8, 0x5B, 0x08, 0x7B, 0xDA, 0x3F, 0x51, 0x7D,
    0xDE, 0x4C, 0xEA, 0xCB, 0x93, 0xA5, 0x6E, 0xCC, 0xE7, 0x8E, 0x10, 0x84,
    0xBD, 0x19, 0x5A, 0x95, 0xE2, 0x0F, 0xCA, 0x1C, 0x50, 0x71, 0x94, 0x51,
    0x40, 0x1B, 0xA5, 0xB6, 0x78, 0x87, 0x53, 0xF6, 0x6A, 0x95, 0xCA, 0xC6,
    0x8D, 0xCD, 0x36, 0x88, 0x07, 0x28, 0xE8, 0x96, 0xCA, 0x78, 0x11, 0x5B,
    0xB8, 0x6A, 0xE7, 0xE5, 0xA6, 0x65, 0x7A, 0x68, 0x15, 0xD7, 0x75, 0xF8,
    0x24, 0x14, 0xCF, 0xD1, 0x0F, 0x6C, 0x56, 0xF5, 0x22, 0xD9, 0xFD, 0xE0,
    0xE2, 0xF4, 0xB3, 0xA1, 0x90, 0x21, 0xA7, 0xE0, 0xE8, 0xB3, 0xC7, 0x25,
    0xBC, 0x07, 0x72, 0x30, 0x5D, 0xEE, 0xF5, 0x6A, 0x89, 0x88, 0x46, 0xDD,
    0x89, 0xC2, 0x39, 0x9C, 0x0A, 0x3B, 0x58, 0x96, 0x57, 0xE4, 0xF3, 0x3C,
    0x79, 0x51, 0x69, 0x36, 0x1B, 0xB6, 0xF7, 0x05, 0x5D, 0x0A, 0x88, 0xDB,
    0x1F, 0x3D, 0xEA, 0xA2, 0xBA, 0x6B, 0xF0, 0xDA, 0x8E, 0x25, 0xC6, 0xAD,
    0x83, 0x7D, 0x3E, 0x31, 0xEE, 0x11, 0x40, 0xA9
};
```

The public key of the ISK, used to verify a signature, can be found in
<https://github.com/01org/linux-sgx/blob/master/psw/ae/data/constants/linux/isk_pub.hh>:

```
/* This is the x component of production public key used for EC-DSA verify for EPID Signing key. */
const uint8_t g_sgx_isk_pubkey_x[] = {
    0x26, 0x9c, 0x10, 0x82, 0xe3, 0x5a, 0x78, 0x26,
    0xee, 0x2e, 0xcc, 0x0d, 0x29, 0x50, 0xc9, 0xa4,
    0x7a, 0x21, 0xdb, 0xcf, 0xa7, 0x6a, 0x95, 0x92,
    0xeb, 0x2f, 0xb9, 0x24, 0x89, 0x88, 0xbd, 0xce
};

/* This is the y component of production public key used for EC-DSA verify. Same as upper. */
const uint8_t g_sgx_isk_pubkey_y[] = {
    0xb8, 0xe0, 0xf2, 0x41, 0xc3, 0xe5, 0x35, 0x52,
    0xbc, 0xef, 0x9c, 0x04, 0x02, 0x06, 0x48, 0xa5,
    0x76, 0x10, 0x1b, 0xa4, 0x28, 0xe4, 0x8e, 0xa9,
    0xcf, 0xba, 0x41, 0x75, 0xdf, 0x06, 0x50, 0x62
};
```

To sign a `QUOTE`, the QE gets the ISK private key via the provisioning
enclave.

As specified in [Enhanced Privacy ID from Bilinear
Pairing](https://eprint.iacr.org/2009/095), EPID relies on bilinear
pairings to achieve the anonymous group signature functionality. In SGX,
it does so using *optimal Ate pairings*, a kind of pairing that
minimizes the number of iterations of the Miller loop, the main
component of a pairing computation. 

SGX computes pairings over elliptic curves, specifically Barreto-Naehrig
curves, along the lines of <http://eprint.iacr.org/2010/354>.

